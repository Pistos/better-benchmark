#!/usr/bin/env ruby

require 'better-benchmark'

module Benchmark
  class Bencher
    def print_usage
      puts "#{$0} [-i <iterations>] -r <revision 1> -r <revision 2> [-p <max p-value>] -- <ruby args...>"
    end

    # @param [Array] argv
    #   The command line arguments passed to the bencher script
    def initialize( argv )
      @iterations = 10

      while argv.any?
        arg = argv.shift
        case arg
        when '-i'
          @iterations = argv.shift.to_i
        when '-p'
          @max_p = argv.shift
        when '-r'
          if @r1.nil?
            @r1 = argv.shift
          else
            @r2 = argv.shift
          end
        when '--'
          @ruby_args = argv.dup
          argv.clear
        end
      end

      if @r1.nil? || @r2.nil? || @ruby_args.nil?
        print_usage
        exit 2
      end
    end

    def time_one_run
      t0 = Time.now
      system "ruby #{ @ruby_args.join(' ') }"  or exit $?
      Time.now.to_f - t0.to_f
    end

    def run
      times1 = []
      times2 = []

      @iterations.times do
        system "git co #{@r1}"  or exit $?
        times1 << time_one_run

        system "git co #{@r2}"  or exit $?
        times2 << time_one_run
      end

      ::Benchmark.report_on(
        ::Benchmark.compare_times( times1, times2, @max_p )
      )
    end
  end

end

b = ::Benchmark::Bencher.new( ARGV.dup )
b.run
